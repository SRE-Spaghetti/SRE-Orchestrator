---
Epic: 5
Story: 10
Title: Add Comprehensive Error Handling and Logging
Status: Done
---

### Story

As a DevOps Engineer, I want comprehensive error handling and logging throughout the refactored system, so that I can troubleshoot issues effectively and monitor system health.

### Acceptance Criteria

1. The LangGraph workflow logs all state transitions and agent decisions
2. All MCP tool invocations are logged with parameters, results, and timing information
3. Errors in the workflow are captured with context and incident status is updated
4. All operations produce structured JSON logs
5. The health endpoint includes status information for LangChain and MCP connections

### Dev Notes

#### LangGraph Workflow Logging
Log structured information for:
- Agent reasoning steps
- Tool invocations with parameters
- Tool execution results
- State transitions
- Investigation progress

Example:
```python
logger.info("workflow_step_started", extra={
    "incident_id": incident_id,
    "step_name": "extract_entities",
    "timestamp": datetime.utcnow().isoformat()
})
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 11]

#### MCP Tool Execution Logging
Log all MCP operations:
```python
logger.info("mcp_tool_executed", extra={
    "tool_name": tool_name,
    "server_name": server_name,
    "arguments": arguments,
    "execution_time_ms": execution_time
})
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 11]

#### Error Handling Strategy
Each workflow node should handle errors gracefully:
```python
def safe_node_wrapper(node_func):
    async def wrapper(state: InvestigationState) -> InvestigationState:
        try:
            return await node_func(state)
        except Exception as e:
            logger.error(f"Error in {node_func.__name__}: {e}", exc_info=True)
            state["status"] = "failed"
            state["error"] = str(e)
            return state
    return wrapper
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 4]

#### Error Recovery
- **LLM Failures**: Retry with exponential backoff (max 3 attempts)
- **MCP Tool Failures**: Log error, mark evidence as unavailable, continue workflow
- **Workflow Failures**: Update incident status to "failed", preserve partial results
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 4]

#### Enhanced Health Endpoint
The health endpoint should include:
```json
{
  "status": "ok",
  "llm": {
    "status": "connected",
    "model": "gpt-4",
    "base_url": "https://api.openai.com/v1"
  },
  "mcp": {
    "status": "connected",
    "servers": [
      {
        "name": "kubernetes",
        "status": "connected",
        "tools_available": 5
      }
    ]
  },
  "agent": {
    "status": "initialized"
  }
}
```
[Source: `.kiro/specs/orchestrator-refactoring/requirements.md` Requirement 8.5]

#### Metrics to Add
```python
# LangGraph workflow metrics
workflow_execution_duration = Histogram("workflow_execution_duration_seconds")
workflow_step_duration = Histogram("workflow_step_duration_seconds", ["step_name"])
workflow_failures = Counter("workflow_failures_total", ["step_name"])

# LLM metrics
llm_request_duration = Histogram("llm_request_duration_seconds", ["operation"])
llm_token_usage = Counter("llm_tokens_used_total", ["operation"])
llm_errors = Counter("llm_errors_total", ["error_type"])

# MCP metrics
mcp_tool_execution_duration = Histogram("mcp_tool_duration_seconds", ["tool_name"])
mcp_tool_errors = Counter("mcp_tool_errors_total", ["tool_name"])
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 11]

### Tasks / Subtasks

- [x] **(AC: 1)** **Add LangGraph Workflow Logging:**
  - Log agent reasoning steps with structured data
  - Log tool invocations with parameters
  - Log tool execution results
  - Add correlation IDs for tracing
  - Log state transitions

- [x] **(AC: 2)** **Add MCP Tool Execution Logging:**
  - Log MCP tool discovery
  - Log tool execution timing with Histogram metrics
  - Log tool errors with full context
  - Add structured logging for all MCP operations

- [x] **(AC: 3)** **Add Error Recovery for Workflow Failures:**
  - Implement retry logic for LLM calls (exponential backoff, max 3 attempts)
  - Handle MCP tool failures gracefully (continue workflow)
  - Update incident status on errors
  - Preserve partial investigation results
  - Wrap workflow nodes with error handling

- [x] **(AC: 4)** **Implement Structured JSON Logging:**
  - Ensure all log statements use structured format
  - Add consistent log levels (INFO, WARNING, ERROR)
  - Include timestamps and correlation IDs
  - Use Python's `logging.extra` for structured data

- [x] **(AC: 5)** **Enhance Health Endpoint:**
  - Add LangChain client status check
  - Add MCP tool availability status
  - Add agent initialization status
  - Return detailed health information as JSON
  - Include error states when components are unhealthy

- [x] **Add Prometheus Metrics:**
  - Implement workflow execution duration histogram
  - Implement workflow step duration histogram
  - Implement workflow failures counter
  - Implement LLM request duration and token usage metrics
  - Implement MCP tool execution metrics

- [x] **Write Unit Tests:**
  - Test error handling in workflow nodes
  - Test retry logic for LLM failures
  - Test MCP tool failure handling
  - Test health endpoint with various states
  - Test structured logging output

- [x] **Create Git Commit:**
  - Commit message: "feat: add comprehensive error handling and logging"
  - Include all logging and error handling improvements
  - Never use "git add -A"

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
