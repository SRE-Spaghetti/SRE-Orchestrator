---
Epic: 4
Story: 2
Title: MCP Client Integration and Connection Management
Status: Ready for Review
---

### Story

**As the** Orchestrator,
**I want** to establish connections to configured MCP servers using the MCP Python client library,
**so that** I can utilize external tools and capabilities provided by MCP servers.

### Acceptance Criteria

1.  The MCP Python client library is added to the project dependencies.
2.  An MCP connection manager service is implemented that handles client connections to configured servers.
3.  Connection initialization includes proper error handling for unreachable servers, authentication failures, and protocol mismatches.
4.  Connection timeouts and retry logic are implemented to handle transient network issues.
5.  MCP client connections are established during application startup based on the loaded configuration.
6.  Connection status and errors are logged with appropriate detail for debugging.

### Dev Notes

#### Previous Story Insights
- Story 4.1 established MCP configuration loading patterns and created `MCPConfigService`
- The configuration schema and loading mechanism are now available for use in connection management
- Following the established pattern of service initialization during FastAPI startup events

#### Dependency Management
- **Package Manager:** Poetry [Source: architecture/tech-stack.md]
- **Dependencies Location:** `services/orchestrator/pyproject.toml` [Source: architecture/source-tree.md]
- **MCP Client Library:** Add `mcp` Python client library to dependencies
- **Existing Pattern:** Similar to `google-generativeai` and `httpx` already in dependencies

#### Connection Management Architecture
- **Service Pattern:** Follow existing service patterns in `services/orchestrator/src/app/services/` [Source: architecture/source-tree.md]
- **Dependency Injection:** Use FastAPI's dependency injection system [Source: architecture/coding-standards.md#critical-rules]
- **Error Handling:** Follow existing patterns, never log sensitive information [Source: architecture/coding-standards.md#critical-rules]
- **Logging:** Use structured logging for connection status and debugging [Source: architecture/coding-standards.md]

#### File Locations
- **Connection Manager:** `services/orchestrator/src/app/services/mcp_connection_manager.py` [Source: architecture/source-tree.md]
- **Dependencies:** Update `services/orchestrator/pyproject.toml` [Source: architecture/source-tree.md]
- **Integration Point:** Update `services/orchestrator/src/app/main.py` startup event [Source: architecture/source-tree.md]

#### Technical Constraints
- **Connection Handling:** Implement async/await patterns for non-blocking connections [Source: architecture/tech-stack.md#fastapi]
- **Error Handling:** Use FastAPI exception handling patterns [Source: architecture/coding-standards.md]
- **Type Hints:** All function signatures must include type hints [Source: architecture/coding-standards.md#python-specifics]
- **Docstrings:** All public functions require docstrings [Source: architecture/coding-standards.md#critical-rules]

### Testing

#### Testing Standards
- **Framework:** pytest [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Location:** `services/orchestrator/tests/unit/` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **Integration Tests:** `services/orchestrator/tests/integration/` [Source: architecture/test-strategy-and-standards.md#integration-tests]
- **Mocking Strategy:** Mock MCP client connections using `unittest.mock` [Source: architecture/test-strategy-and-standards.md#unit-tests]
- **External API Mocking:** Use `pytest-httpserver` for MCP server mocking [Source: architecture/test-strategy-and-standards.md#integration-tests]

### Tasks / Subtasks

1. **Add MCP Client Dependencies (AC: 1)**
   - [x] Add `mcp` Python client library to `services/orchestrator/pyproject.toml`
   - [x] Update dependencies with `poetry install`
   - [x] Verify compatibility with existing Python 3.12.11 requirement

2. **Implement MCP Connection Manager Service (AC: 2, 3, 4, 6)**
   - [x] Create `MCPConnectionManager` class in `services/orchestrator/src/app/services/mcp_connection_manager.py`
   - [x] Implement async connection initialization methods
   - [x] Add comprehensive error handling for connection failures, authentication issues, protocol mismatches
   - [x] Implement connection timeout and retry logic with exponential backoff
   - [x] Add structured logging for connection status, errors, and debugging information
   - [x] Follow FastAPI dependency injection patterns

3. **Integrate with Application Startup (AC: 5)**
   - [x] Update `services/orchestrator/src/app/main.py` startup event
   - [x] Initialize `MCPConnectionManager` during application startup
   - [x] Load MCP configuration using existing `MCPConfigService` from Story 4.1
   - [x] Establish connections to all configured MCP servers
   - [x] Handle startup failures gracefully without preventing application launch

4. **Write Comprehensive Tests (AC: 1-6)**
   - [x] Create `test_mcp_connection_manager.py` in `services/orchestrator/tests/unit/`
   - [x] Test successful connection establishment with mocked MCP clients
   - [x] Test connection failure scenarios (unreachable servers, auth failures, protocol mismatches)
   - [x] Test timeout and retry logic behavior
   - [x] Test logging output for various scenarios
   - [x] Create integration test in `services/orchestrator/tests/integration/` with mock MCP server
   - [x] Achieve 80% test coverage requirement

### Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-08 | 1.0 | Initial story creation | Sarah (PO) |

### Dev Agent Record

#### Agent Model Used

#### Debug Log References

#### Completion Notes List

#### File List

### QA Results