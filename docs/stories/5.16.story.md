---
Epic: 5
Story: 16
Title: Native Graph Integration and Testing
Status: Done
---

### Story

As an SRE and Developer, I want comprehensive testing and validation of the native LangGraph implementation with feature flag support, so that I can safely deploy the new implementation with confidence and easily rollback if needed.

### Acceptance Criteria

1. The investigate_incident function works with the native graph implementation
2. The investigation results maintain the same structure as the prebuilt agent
3. All existing tests pass without modification
4. Integration tests validate full graph execution with mock tools
5. Backward compatibility tests compare results between implementations
6. Performance tests verify similar execution time (within 10%)
7. Concurrent investigation tests verify no state leakage
8. Documentation is updated to reflect native graph implementation
9. The default implementation can be switched via feature flag
10. Deployment configuration includes the USE_NATIVE_LANGGRAPH setting

### Dev Notes

#### Integration with investigate_incident

The `investigate_incident` function is the main entry point for investigations. It needs to work with the native graph while maintaining the same interface and result structure.

**Updated Function:**
```python
async def investigate_incident(
    incident_id: str,
    description: str,
    mcp_tools: List[Any],
    llm_config: Dict[str, Any],
    correlation_id: Optional[str] = None
) -> Dict[str, Any]:
    """
    Investigate an incident using the LangGraph agent.

    This function supports both prebuilt and native graph implementations
    via the USE_NATIVE_LANGGRAPH feature flag.
    """
    try:
        # Create agent (uses feature flag internally)
        agent = await create_investigation_agent(
            mcp_tools=mcp_tools,
            llm_config=llm_config,
            correlation_id=correlation_id
        )

        # Create initial state
        initial_state = {
            "messages": [
                SystemMessage(content=INVESTIGATION_SYSTEM_PROMPT),
                HumanMessage(content=description)
            ],
            "incident_id": incident_id,
            "correlation_id": correlation_id,
            "investigation_status": "in_progress"
        }

        # Invoke agent
        result = await agent.ainvoke(initial_state)

        # Extract results (same helper functions as before)
        messages = result["messages"]
        final_message = messages[-1]

        return {
            "root_cause": extract_root_cause(final_message),
            "confidence": extract_confidence(final_message),
            "evidence": extract_evidence(messages),
            "reasoning": final_message.content,
            "recommendations": extract_recommendations(final_message),
            "tool_calls": extract_tool_calls(messages),
            "status": "completed",
            "correlation_id": correlation_id,
            "duration_seconds": calculate_duration(result),
            "error": None
        }

    except Exception as e:
        logger.error(
            "Investigation failed",
            extra={"correlation_id": correlation_id, "error": str(e)},
            exc_info=True
        )
        return {
            "status": "failed",
            "error": str(e),
            "correlation_id": correlation_id
        }
```

[Source: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 6]

#### Backward Compatibility

The native graph must produce the same result structure and behavior:

**Result Structure:**
```python
{
    "root_cause": str,
    "confidence": Literal["high", "medium", "low"],
    "evidence": List[Dict[str, Any]],
    "reasoning": str,
    "recommendations": List[str],
    "tool_calls": List[Dict[str, Any]],
    "status": Literal["completed", "failed"],
    "correlation_id": str,
    "duration_seconds": float,
    "error": Optional[str]
}
```

This structure must remain unchanged to maintain API compatibility.

[Source: `.kiro/specs/native-langgraph-refactoring/requirements.md` Requirement 5]

#### Testing Strategy

**Unit Tests:**
- State schema creation and updates
- Routing logic with various message types
- Agent node execution with mock LLM
- Tool node execution with mock tools
- Error handling in each node

**Integration Tests:**
- Full graph execution from start to end
- Multi-iteration workflows (tool calls → agent → tool calls → agent → end)
- Error handling in complete workflow
- State accumulation throughout execution

**Backward Compatibility Tests:**
- Run same incident with both implementations
- Compare result structures
- Compare result quality (within acceptable variance)
- Verify all fields are present

**Performance Tests:**
- Measure execution time for both implementations
- Verify native graph is within 10% of prebuilt agent
- Test with various incident complexities
- Monitor resource usage (memory, CPU)

**Concurrent Tests:**
- Run multiple investigations in parallel
- Verify no state leakage between investigations
- Verify performance doesn't degrade significantly
- Check for race conditions

[Source: `.kiro/specs/native-langgraph-refactoring/tasks.md` Tasks 8, 10]

#### Migration and Rollout

**Phase 1: Implementation (Complete)**
- Native graph code implemented
- Feature flag added
- Tests written

**Phase 2: Validation (This Story)**
- Run parallel tests comparing implementations
- Performance validation
- Backward compatibility verification

**Phase 3: Staged Rollout**
1. Enable in development environment
2. Enable in staging environment
3. Monitor metrics and logs
4. Enable in production
5. Monitor for issues

**Phase 4: Default Switch**
1. Change default to USE_NATIVE_LANGGRAPH=true
2. Update Helm charts
3. Deploy to all environments
4. Monitor production

**Phase 5: Cleanup (Future Story)**
1. Remove prebuilt agent code
2. Remove feature flag
3. Simplify implementation

[Source: `.kiro/specs/native-langgraph-refactoring/tasks.md` Tasks 10, 11]

#### Rollback Plan

If issues are found:

**Before Default Switch:**
- Simply don't enable the feature flag

**After Default Switch (Early):**
- Set USE_NATIVE_LANGGRAPH=false in deployment
- Restart services
- Monitor for stability

**After Default Switch (Late):**
- Revert deployment commit
- Redeploy previous version

**After Cleanup:**
- Revert cleanup commit
- Restore prebuilt agent code

[Source: `.kiro/specs/native-langgraph-refactoring/design.md` Rollback Plan]

#### Documentation Updates

**Files to Update:**
- **langgraph-workflow.md**: Update with native graph details
- **extending-investigation-graph.md**: New guide for extending the graph
- **investigation_agent.py**: Complete docstrings for all functions
- **README.md**: Update architecture section and environment variables
- **deployment/helm/values.yaml**: Add USE_NATIVE_LANGGRAPH setting

[Source: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 9]

### Tasks / Subtasks

- [x] **(AC: 1, 2)** **Update investigate_incident Function:**
  - Modify to work with compiled graph agent
  - Create initial state with messages, incident_id, correlation_id, investigation_status
  - Add SystemMessage with INVESTIGATION_SYSTEM_PROMPT
  - Add HumanMessage with incident description
  - Invoke agent with initial state using agent.ainvoke()
  - Extract results from graph output
  - Maintain backward-compatible return structure
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 6

- [x] **(AC: 3)** **Run Existing Tests:**
  - Execute all existing investigation tests
  - Verify they pass with feature flag disabled
  - Verify they pass with feature flag enabled
  - Document any test modifications needed
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 8.5

- [x] **(AC: 4)** **Write Integration Tests:**
  - Test full graph execution with mock tools
  - Test graph with tool calls and responses
  - Test graph with final answer (no tools)
  - Test graph error handling
  - Test graph with multiple tool call iterations
  - Verify message accumulation throughout workflow
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 8.4

- [x] **(AC: 5)** **Write Backward Compatibility Tests:**
  - Test native graph produces same result structure as prebuilt
  - Test all result fields are present
  - Test error handling produces same structure
  - Compare results from both implementations with same input
  - Allow for acceptable variance in LLM outputs
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 8.5

- [x] **(AC: 6)** **Run Performance Tests:**
  - Create test script to compare execution time
  - Run with same incidents and measure duration
  - Verify native graph is within 10% of prebuilt
  - Document performance results
  - Test with various incident complexities
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 10.1

- [x] **(AC: 7)** **Test Concurrent Investigations:**
  - Run multiple investigations concurrently with native graph
  - Verify no performance degradation
  - Verify no state leakage between investigations
  - Test with high concurrency (10+ parallel investigations)
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 10.3

- [x] **(AC: 8)** **Update Documentation:**
  - Update langgraph-workflow.md with native graph details
  - Create extending-investigation-graph.md guide
  - Update investigation_agent.py docstrings
  - Update README.md architecture section
  - Document USE_NATIVE_LANGGRAPH environment variable
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 9

- [x] **(AC: 9, 10)** **Configure Feature Flag Default:**
  - Set USE_NATIVE_LANGGRAPH default to true in config
  - Update .env.example
  - Update Helm chart values.yaml
  - Update Docker environment variables
  - Document rollback procedure
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 11

- [x] **Run Validation Tests:**
  - Enable feature flag in test environment
  - Run both implementations with same incidents
  - Compare results for consistency
  - Document any discrepancies
  - Verify acceptable variance in LLM responses
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 10.2

- [x] **Monitor Production Deployment:**
  - Deploy to staging first
  - Monitor logs for errors
  - Monitor performance metrics
  - Verify investigation quality
  - Create monitoring dashboard for graph execution
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 11.3

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-15 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
Claude Sonnet 4.5

#### Debug Log References
_TBD_

#### Completion Notes List
- investigate_incident function updated to work with native graph
- Comprehensive test suite covers all aspects of graph execution
- Backward compatibility verified through comparison tests
- Performance validated to be within 10% of prebuilt implementation
- Feature flag enables safe rollout and easy rollback
- Documentation updated to reflect native graph architecture
- Default switched to native graph after validation
- Monitoring confirms stable production operation

#### File List
- investigation_agent.py: Updated investigate_incident function
- tests/test_graph_integration.py: Integration tests
- tests/test_backward_compatibility.py: Compatibility tests
- tests/test_performance.py: Performance comparison tests
- tests/test_concurrent_investigations.py: Concurrency tests
- docs/langgraph-workflow.md: Updated documentation
- docs/extending-investigation-graph.md: New extension guide
- README.md: Updated architecture section
- deployment/helm/values.yaml: Feature flag configuration

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
