---
Epic: 5
Story: 4
Title: Implement LangGraph ReAct Agent Workflow
Status: Done
---

### Story

As an SRE, I want the orchestrator to use a LangGraph ReAct agent for incident investigation, so that the system can autonomously decide which tools to use and intelligently analyze incidents.

### Acceptance Criteria

1. A new investigation agent module is created at `src/app/core/investigation_agent.py`
2. The module implements `create_investigation_agent()` function using LangGraph's `create_react_agent`
3. The agent is configured with a system prompt for SRE investigations
4. The agent uses MCP tools from the tool manager
5. An `investigate_incident()` function executes the agent and extracts results
6. The investigation results include root cause, confidence, evidence, and reasoning

### Dev Notes

#### Module Location
- **File Path:** `src/app/core/investigation_agent.py`
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 4.1]

#### ReAct Agent Pattern
Use LangGraph's `create_react_agent` which implements the ReAct (Reasoning + Acting) pattern:
```python
from langgraph.prebuilt import create_react_agent
from langchain.chat_models import init_chat_model

async def create_investigation_agent(mcp_config: Dict[str, Any]):
    # Initialize MCP client and get tools
    mcp_client = MultiServerMCPClient(mcp_config)
    tools = await mcp_client.get_tools()

    # Create ReAct agent
    model = init_chat_model(
        model=os.getenv("LLM_MODEL", "gpt-4"),
        base_url=os.getenv("LLM_BASE_URL"),
        api_key=os.getenv("LLM_API_KEY")
    )

    agent = create_react_agent(
        model=model,
        tools=tools,
        state_modifier=system_prompt
    )

    return agent
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 1]

#### System Prompt
```
You are an expert SRE assistant investigating production incidents.

When given an incident description, follow this process:
1. Analyze the description to understand the problem
2. Use available Kubernetes tools to gather evidence:
   - Get pod details and status
   - Retrieve pod logs
   - Check resource usage and limits
   - View recent events
3. Correlate the evidence to identify patterns
4. Determine the root cause with confidence level
5. Provide actionable recommendations

Always explain your reasoning and cite specific evidence from the tools.
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 1]

#### Investigation Execution
```python
async def investigate_incident(incident_id: str, description: str) -> Dict[str, Any]:
    agent = await create_investigation_agent(mcp_config)

    result = await agent.ainvoke({
        "messages": [
            ("system", "Investigate this incident and provide root cause analysis."),
            ("human", description)
        ]
    })

    final_message = result["messages"][-1]

    return {
        "root_cause": extract_root_cause(final_message.content),
        "confidence": extract_confidence(final_message.content),
        "evidence": extract_evidence(result["messages"]),
        "reasoning": final_message.content
    }
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 1]

#### Result Parsing
Helper functions to extract structured information from agent response:
- `extract_root_cause()`: Parse root cause from final message
- `extract_confidence()`: Extract confidence level (high/medium/low)
- `extract_evidence()`: Collect all tool results as evidence
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 4.3]

### Tasks / Subtasks

- [x] **(AC: 1, 2)** **Create Agent Factory Function:**
  - Create file `src/app/core/investigation_agent.py`
  - Implement `create_investigation_agent()` function
  - Use `create_react_agent` from LangGraph

- [x] **(AC: 3)** **Configure System Prompt:**
  - Create comprehensive system prompt for SRE investigations
  - Include step-by-step investigation process
  - Emphasize evidence-based reasoning

- [x] **(AC: 4)** **Integrate MCP Tools:**
  - Get tools from MCP tool manager
  - Pass tools to ReAct agent
  - Ensure tools are properly formatted for LangChain

- [x] **(AC: 5)** **Implement Investigation Execution:**
  - Create `investigate_incident()` async function
  - Invoke ReAct agent with incident description
  - Handle agent execution errors
  - Update incident status throughout execution

- [x] **(AC: 6)** **Add Result Parsing:**
  - Implement `extract_root_cause()` helper function
  - Implement `extract_confidence()` helper function
  - Implement `extract_evidence()` helper function
  - Parse agent messages to extract structured information

- [x] **Write Integration Tests:**
  - Test agent with mock MCP tools
  - Test investigation workflow end-to-end
  - Test error handling in agent execution
  - Verify incident status updates

- [x] **Create Git Commit:**
  - Commit message: "feat: implement LangGraph ReAct agent for incident investigation"
  - Include agent factory and investigation execution code

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
