---
Epic: 2
Story: 4
Title: Orchestrator Integration
Status: Ready for Review
---

### Story

As the Orchestrator, I want to call the Kubernetes Agent's internal API to retrieve pod details and logs, so that I can incorporate this data into my investigation process.

### Acceptance Criteria

1.  The main orchestrator service is updated to be able to discover and communicate with the Kubernetes Agent service (e.g., via Kubernetes service DNS).
2.  When an incident is created (from Story 1.3), the orchestrator's internal logic is updated to make a placeholder call to the Kubernetes Agent.
3.  For now, the orchestrator will be hard-coded to request details and logs for a pod name it extracts from the incident description.
4.  The data returned from the agent is stored as part of the incident's data in the in-memory store.
5.  The `GET /api/v1/incidents/{id}` endpoint is updated to include a new `evidence` field containing the data collected from the agent.

### Dev Notes

#### Service Communication
- **Pattern:** The Orchestrator will act as a client, making synchronous REST API calls to the K8s Agent. [Source: `architecture/high-level-architecture.md`]
- **Service Discovery:** Communication should use standard Kubernetes service DNS (e.g., `http://sre-orchestrator-k8s-agent.default.svc.cluster.local`). The base URL for the agent should be configurable via an environment variable.
- **Client Library:** Use a standard HTTP client library like `httpx` or `requests` to make the calls. `httpx` is recommended for its async support, which aligns well with FastAPI.

#### Project Structure
- **K8s Agent Client:** Create a new client service in the Orchestrator at `services/orchestrator/app/services/k8s_agent_client.py`. [Source: `architecture/source-tree.md`]
- **Logic Integration:** The incident creation logic in the Orchestrator's core services/repositories should be updated to call this new client.

#### Data Models
- **Incident Model:** The `Incident` Pydantic model in the Orchestrator should be updated to include the `evidence` field as a dictionary. [Source: `architecture/data-models.md`]

#### Testing
- **Framework:** `pytest` with `pytest-httpx` [Source: `architecture/test-strategy-and-standards.md`]
- **Location:** `services/orchestrator/tests/unit/` [Source: `architecture/test-strategy-and-standards.md`]
- **Coverage:** Unit tests should mock the HTTP calls made by the new K8s Agent Client. Tests for the incident creation logic should be updated to assert that the client is called and that the `evidence` field is populated correctly. [Source: `architecture/test-strategy-and-standards.md`]

### Tasks / Subtasks

1.  (AC: 1) **Create K8s Agent Client:**
    - [x] In `services/orchestrator/app/services/`, create `k8s_agent_client.py`.
    - [x] Add `httpx` to the orchestrator's `pyproject.toml`.
    - [x] Create a client class that is initialized with the base URL of the K8s Agent service.
    - [x] Implement methods like `get_pod_details(namespace, name)` and `get_pod_logs(namespace, name)` that call the corresponding endpoints on the K8s Agent API.
    - [x] This client should be provided to other services via FastAPI's dependency injection.
2.  (AC: 2, 3, 4) **Update Incident Creation Workflow:**
    - [x] Modify the `create` method in the incident repository/service (`services/orchestrator/app/core/incident_repository.py`).
    - [x] After the incident is first created in memory, inject the `K8sAgentClient`.
    - [x] **(Placeholder Logic)**: Implement a simple, temporary function to parse the pod name and a default namespace from the incident `description` string.
    - [x] Call the client's `get_pod_details` and `get_pod_logs` methods.
    - [x] Store the results in the `evidence` field of the incident object in the in-memory store.
3.  (AC: 5) **Update Incident Status Endpoint:**
    - [x] Modify the `GET /api/v1/incidents/{id}` endpoint to ensure the `evidence` field is included in the response.
    - [x] Update the `Incident` Pydantic model used for the response to include the `evidence` field.
4.  **Write Unit Tests:**
    - [x] In `services/orchestrator/tests/unit/`, write unit tests for the new `K8sAgentClient`, using a library like `pytest-httpx` to mock the HTTP requests.
    - [x] Update the unit tests for the incident creation and retrieval endpoints to verify that the client is called and that the `evidence` field is correctly populated and returned.

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| _TBD_ | 1.0 | Initial Draft | _TBD_ |

### Dev Agent Record

#### Agent Model Used
Gemini

#### Debug Log References
- Added `httpx` to orchestrator's `pyproject.toml`.
- Created `k8s_agent_client.py`.
- Copied `pod_details.py` to orchestrator's models.
- Updated `Incident` Pydantic model with `evidence` field.
- Modified `incident_repository.py` to use `K8sAgentClient`.
- Modified `incidents.py` to inject `K8sAgentClient`.
- Wrote unit tests for `K8sAgentClient` and updated existing tests.
- Fixed `NameError: name 'Dict' is not defined` by adding `from typing import Dict, Any`.
- Fixed `httpx` mocking issues in `test_k8s_agent_client.py`.

#### Completion Notes List
- All tasks for Story 2.4 completed and verified with passing tests.

#### File List
- services/orchestrator/pyproject.toml
- services/orchestrator/app/services/k8s_agent_client.py
- services/orchestrator/app/models/pod_details.py
- services/orchestrator/app/models/incidents.py
- services/orchestrator/app/core/incident_repository.py
- services/orchestrator/app/api/v1/incidents.py
- services/orchestrator/tests/unit/test_k8s_agent_client.py

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
