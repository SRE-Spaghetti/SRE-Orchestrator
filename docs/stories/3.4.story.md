---
Epic: 3
Story: 4
Title: Final Report Generation
Status: Draft
---

### Story

As an SRE, I want the final investigation report to include the LLM's analysis and the correlation engine's suggested root cause, so that I have a complete, actionable summary of the incident.

### Acceptance Criteria

1.  The orchestrator's main investigation workflow is updated to call the new correlation engine after gathering evidence.
2.  The `status` of the incident is updated from "pending" to "completed" once the correlation is finished.
3.  The `GET /api/v1/incidents/{id}` endpoint is updated to include the final report.
4.  The response body now includes the `suggested_root_cause`, the `confidence_score`, and the supporting `evidence`.

### Dev Notes

#### API Specifications
- **Endpoint:** `GET /api/v1/incidents/{id}`
- **Response Body:** The response for this endpoint should now be guaranteed to include `suggested_root_cause` and `confidence_score` for completed incidents. [Source: `architecture/rest-api-spec.md`]

#### Data Models
- **Incident Model:** The `Incident` Pydantic model should be updated to include `completed_at` (datetime) and ensure all new fields (`evidence`, `extracted_entities`, `suggested_root_cause`, `confidence_score`) are present. [Source: `architecture/data-models.md`]

#### Previous Story Insights
- This story ties together the work of the entire project so far, updating the main workflow to be a true end-to-end process.

### Tasks / Subtasks

1.  **(AC: 1, 2)** **Finalize Incident Workflow:**
    - In the main incident creation logic (`services/orchestrator/app/core/`), after the correlation engine runs, update the incident's status to "completed".
    - Set a `completed_at` timestamp on the incident object.
2.  **(AC: 3, 4)** **Update API Endpoint and Response Model:**
    - Review the `GET /api/v1/incidents/{id}` endpoint to ensure it returns all the new fields on the `Incident` model.
    - Update the `Incident` Pydantic model in `services/orchestrator/app/models/` to include `completed_at` and make sure all other new fields from this epic are included.
3.  **Write Unit and Integration Tests:**
    - **Unit Tests:** Update the unit tests for the `GET` endpoint to verify that all fields of a completed incident report are returned correctly.
    - **Integration Test:** Create a simple end-to-end test (in `services/orchestrator/tests/integration/`) that:
        - Mocks the K8s Agent and LLM APIs.
        - Calls `POST /api/v1/incidents` to create an incident.
        - Polls `GET /api/v1/incidents/{id}` until the status is "completed".
        - Asserts that the final report contains the expected (mocked) evidence, entities, and a root cause.

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
