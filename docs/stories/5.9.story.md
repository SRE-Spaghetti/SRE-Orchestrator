---
Epic: 5
Story: 9
Title: Update Helm Chart Configuration
Status: Done
---

### Story

As a DevOps Engineer, I want the Helm chart updated to support the new architecture with LLM and MCP configurations, so that I can deploy the refactored orchestrator to Kubernetes.

### Acceptance Criteria

1. The orchestrator deployment includes environment variables for LLM configuration
2. A secret template is created for LLM API credentials
3. The values.yaml includes configuration sections for LLM and MCP
4. All k8s-agent references are removed from the Helm chart
5. The chart can be successfully deployed to a Kubernetes cluster

### Dev Notes

#### Deployment Configuration
**File:** `charts/sre-orchestrator/templates/deployment-orchestrator.yaml`

Add environment variables:
```yaml
env:
  - name: LLM_BASE_URL
    value: "{{ .Values.llm.baseUrl }}"
  - name: LLM_API_KEY
    valueFrom:
      secretKeyRef:
        name: llm-credentials
        key: api-key
  - name: LLM_MODEL_NAME
    value: "{{ .Values.llm.modelName }}"
  - name: LLM_TEMPERATURE
    value: "{{ .Values.llm.temperature | default 0.7 }}"
  - name: LLM_MAX_TOKENS
    value: "{{ .Values.llm.maxTokens | default 2000 }}"
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 7]

#### LLM Credentials Secret
**File:** `charts/sre-orchestrator/templates/secret-llm.yaml`

Create secret template:
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: llm-credentials
type: Opaque
stringData:
  api-key: {{ .Values.llm.apiKey | required "LLM API key is required" }}
```
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 9.2]

#### Values Configuration
**File:** `charts/sre-orchestrator/values.yaml`

Add LLM configuration:
```yaml
llm:
  baseUrl: "https://api.openai.com/v1"
  modelName: "gpt-4"
  apiKey: ""  # Should be provided via --set or external secret
  temperature: 0.7
  maxTokens: 2000
```

Add MCP configuration:
```yaml
mcp:
  servers:
    - name: kubernetes
      url: "http://kubernetes-mcp-server:8080"
      transport: http
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 7]

#### Resource Limits
Consider updating resource limits based on new architecture:
- Memory: Increase slightly for LangGraph state management (~200-500Mi)
- CPU: Should remain similar (I/O bound workload)
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 10]

#### Removed Files
These files should already be deleted in Story 5.6, but verify:
- `deployment-k8s-agent.yaml`
- `service-k8s-agent.yaml`
- `rbac-k8s-agent.yaml`
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 6.3]

### Tasks / Subtasks

- [x] **(AC: 1)** **Update Orchestrator Deployment:**
  - Edit `charts/sre-orchestrator/templates/deployment-orchestrator.yaml`
  - Add LLM_BASE_URL environment variable
  - Add LLM_API_KEY from secret reference
  - Add LLM_MODEL_NAME environment variable
  - Add optional LLM_TEMPERATURE and LLM_MAX_TOKENS
  - Remove any k8s-agent service references

- [x] **(AC: 2)** **Create LLM Credentials Secret:**
  - Create `charts/sre-orchestrator/templates/secret-llm.yaml`
  - Template the API key from values
  - Add validation to require API key
  - Document how to provide API key securely

- [x] **(AC: 3)** **Update Values.yaml:**
  - Add `llm` configuration section with baseUrl, modelName, apiKey, etc.
  - Add `mcp` configuration section with servers list
  - Remove k8s-agent configuration section
  - Add comments explaining each configuration option
  - Set sensible defaults

- [x] **(AC: 4)** **Verify K8s-Agent Removal:**
  - Confirm deletion of deployment-k8s-agent.yaml
  - Confirm deletion of service-k8s-agent.yaml
  - Confirm deletion of rbac-k8s-agent.yaml
  - Search for any remaining k8s-agent references in templates

- [x] **(AC: 5)** **Test Deployment:**
  - Install chart in test cluster: `helm install sre-orchestrator charts/sre-orchestrator`
  - Verify all pods start successfully
  - Check environment variables are set correctly
  - Test health endpoint
  - Verify LLM connection works

- [x] **Update Chart Documentation:**
  - Update `charts/sre-orchestrator/README.md`
  - Document new configuration options
  - Provide example values for different LLM providers
  - Document secret management best practices

- [x] **Create Git Commit:**
  - Commit message: "chore: update Helm chart for refactored architecture"
  - Include all Helm chart configuration changes
  - Never use "git add -A"

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
