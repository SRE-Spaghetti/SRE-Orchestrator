---
Epic: 5
Story: 3
Title: Implement MCP Tool Integration with LangChain
Status: Done
---

### Story

As a Developer, I want to implement an MCP tool manager that discovers tools from MCP servers and provides them as LangChain-compatible tools, so that the LangGraph workflow can dynamically execute Kubernetes operations.

### Acceptance Criteria

1. A new MCP tool manager module is created at `src/app/services/mcp_tool_manager.py`
2. The manager uses `MultiServerMCPClient` from langchain-mcp-adapters
3. The manager can initialize connections to multiple MCP servers
4. The manager provides a `get_tools()` method that returns LangChain-compatible tools
5. The manager is integrated with FastAPI startup and stored in app.state
6. The health endpoint is updated to show MCP tool status

### Dev Notes

#### Module Location
- **File Path:** `src/app/services/mcp_tool_manager.py`
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 3.1]

#### MCP Client Integration
Use `langchain-mcp-adapters` library's `MultiServerMCPClient`:
```python
from langchain_mcp_adapters.client import MultiServerMCPClient

class MCPToolManager:
    def __init__(self, mcp_config: Dict[str, Any]):
        self.client = MultiServerMCPClient(mcp_config)
        self.tools = None

    async def initialize(self):
        self.tools = await self.client.get_tools()
        return self.tools

    async def get_tools(self) -> List[Any]:
        if self.tools is None:
            await self.initialize()
        return self.tools
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 3]

#### Configuration Format
The MCP configuration should support both stdio and streamable_http transports:
```yaml
kubernetes:
  url: "http://k8s-mcp-server:8080/mcp"
  transport: "streamable_http"
  headers:
    Authorization: "Bearer token"

prometheus:
  command: "python"
  args: ["/path/to/prometheus_server.py"]
  transport: "stdio"
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 3]

#### FastAPI Integration
- Initialize `MCPToolManager` in `startup_event`
- Store in `app.state.mcp_tool_manager`
- Handle initialization errors gracefully
- Update health endpoint to include MCP status
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 3.3]

#### Error Handling
```python
class MCPToolError(Exception):
    """Base exception for MCP tool execution errors"""

class MCPToolNotFoundError(MCPToolError):
    """Tool not available on any connected server"""

class MCPToolExecutionError(MCPToolError):
    """Tool execution failed"""
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 4]

### Tasks / Subtasks

- [x] **(AC: 1, 2)** **Create MCP Tool Manager Module:**
  - Create file `src/app/services/mcp_tool_manager.py`
  - Implement `MCPToolManager` class wrapping `MultiServerMCPClient`
  - Add `initialize()` method to load tools from all MCP servers

- [x] **(AC: 4)** **Implement Tool Discovery:**
  - Add `get_tools()` method returning LangChain-compatible tools
  - Add `cleanup()` method for connection management
  - Implement error handling for tool discovery failures

- [x] **(AC: 3)** **Update MCP Configuration:**
  - Update `mcp_config.yaml` to match `MultiServerMCPClient` format
  - Support both stdio and streamable_http transports
  - Add example configuration for Kubernetes MCP server
  - Document configuration options

- [x] **(AC: 5)** **Integrate with FastAPI:**
  - Initialize `MCPToolManager` in startup_event
  - Store tool manager in `app.state`
  - Handle initialization errors gracefully

- [x] **(AC: 6)** **Update Health Endpoint:**
  - Add MCP tool status to health endpoint response
  - Show number of discovered tools
  - Show connection status for each MCP server

- [x] **Write Unit Tests:**
  - Test tool discovery with mock MCP servers
  - Test tool initialization
  - Test error handling for unavailable servers
  - Test health endpoint with MCP status

- [x] **Create Git Commit:**
  - Commit message: "feat: integrate MCP tools using langchain-mcp-adapters"
  - Include MCP tool manager and configuration updates

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
