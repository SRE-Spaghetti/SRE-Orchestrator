---
Epic: 2
Story: 3
Title: Retrieve Pod Logs
Status: Draft
---

### Story

As the Orchestrator, I want to request the logs from a specific pod's container from the Kubernetes Agent, so that I can analyze them for error messages.

### Acceptance Criteria

1.  The Kubernetes Agent exposes an internal API endpoint (`GET /api/v1/pods/{namespace}/{name}/logs`).
2.  The endpoint accepts optional query parameters to specify the container name and the number of log lines to retrieve (e.g., `?container=app&tail=100`).
3.  When called, the agent uses the Kubernetes API to stream the logs from the specified container.
4.  The agent returns the logs as a plain text or JSON response.
5.  If the pod or container is not found, or if logs are not available, an appropriate error is returned.

### Dev Notes

#### API Specifications
- **Endpoint:** `GET /api/v1/pods/{namespace}/{name}/logs` [Source: `architecture/components.md`]
- **Path Parameters:** `namespace` (string), `name` (string)
- **Query Parameters:**
  - `container`: `string` (optional) - The name of the container.
  - `tail`: `int` (optional, default: 100) - The number of lines to retrieve from the end of the logs.
- **Success Response (200 OK):**
  - **Content-Type:** `text/plain`
  - **Body:** The raw log text.
- **Error Response (404 Not Found):** Standard FastAPI 404 response if the pod or container does not exist.

#### Project Structure
- **API Endpoint:** Implement in the pods router under `services/k8s-agent/app/api/v1/`.
- **Core Logic:** Extend the `k8s_client` service (`services/k8s-agent/app/services/`) with a new method to fetch logs.

#### Previous Story Insights
- This story builds on the `k8s-agent` service foundation from Story 2.1 and the pod interaction patterns from Story 2.2.

### Tasks / Subtasks

1.  **(AC: 2, 3, 5)** **Extend Kubernetes Client Service:**
    - In `services/k8s-agent/app/services/k8s_client.py`, create a new method `get_pod_logs(namespace: str, name: str, container: str = None, tail: int = 100)`.
    - This method should use the initialized Kubernetes client to call `read_namespaced_pod_log`.
    - Pass the `container` and `tail_lines=tail` arguments to the client method.
    - Wrap the API call in a `try...except` block to catch `kubernetes.client.ApiException` (for 404s) and return `None`.
2.  **(AC: 1, 4)** **Implement API Endpoint:**
    - In the pods router in `services/k8s-agent/app/api/v1/`, implement the `GET /api/v1/pods/{namespace}/{name}/logs` endpoint.
    - Use FastAPI's dependency injection to get the Kubernetes client service.
    - Accept the optional `container` and `tail` query parameters.
    - Call the `get_pod_logs` method.
    - If logs are returned, respond with a `PlainTextResponse` and a 200 OK status.
    - If `None` is returned, raise a `404 HTTPException`.
3.  **Write Unit Tests:**
    - In `services/k8s-agent/tests/unit/`, add tests for the new logs endpoint.
    - Mock the `k8s_client` service.
    - Test the success case, verifying the endpoint returns 200 OK and the mock log content.
    - Test the case where query parameters (`container`, `tail`) are used, ensuring they are passed correctly to the service.
    - Test the failure case where the service returns `None`, verifying the endpoint returns 404 Not Found.

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
