---
Epic: 5
Story: 12
Title: Update Deployment and CI/CD
Status: Done
---

### Story

As a DevOps Engineer, I want updated deployment artifacts and CI/CD pipeline for the refactored system, so that I can build, test, and deploy the new architecture consistently.

### Acceptance Criteria

1. The Docker build is updated with new dependencies and k8s-agent removed
2. The CLI is packaged and can be installed via pip/pipx
3. The CI/CD pipeline is updated to test the new structure
4. All build and deployment jobs succeed
5. The deployment can be successfully installed in a Kubernetes cluster

### Dev Notes

#### Docker Build Updates
**File:** `Dockerfile` (orchestrator)

Updates needed:
- Update base image if needed
- Install new dependencies (langchain, langgraph, langchain-mcp-adapters)
- Remove k8s-agent build steps
- Optimize image size by removing unnecessary packages
- Test Docker build locally before committing
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 12.1]

Example optimization:
```dockerfile
# Use multi-stage build to reduce image size
FROM python:3.12-slim as builder
WORKDIR /app
COPY pyproject.toml poetry.lock ./
RUN pip install poetry && poetry install --no-dev

FROM python:3.12-slim
COPY --from=builder /app/.venv /app/.venv
COPY src /app/src
ENV PATH="/app/.venv/bin:$PATH"
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
```

#### CLI Distribution Package
**File:** `cli/pyproject.toml`

Configure for distribution:
```toml
[project]
name = "sre-orchestrator-cli"
version = "0.1.0"
description = "CLI for SRE Orchestrator"

[project.scripts]
sre-orchestrator = "sre_orchestrator_cli.main:cli"

[build-system]
requires = ["poetry-core>=1.0.0"]
build-backend = "poetry.core.masonry.api"
```
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 12.2]

Installation testing:
```bash
# Test with pip
pip install cli/

# Test with pipx (recommended for CLIs)
pipx install cli/
```

#### CI/CD Pipeline Updates
**File:** `.github/workflows/ci.yml` (or similar)

Updates needed:
- Update test jobs for new structure
- Remove k8s-agent build and test jobs
- Add CLI build and test jobs
- Add coverage reporting
- Update deployment jobs to use new Helm chart
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 12.3]

Example job structure:
```yaml
jobs:
  test-orchestrator:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install dependencies
        run: poetry install
      - name: Run tests
        run: poetry run pytest --cov

  test-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Install CLI
        run: pip install cli/
      - name: Run CLI tests
        run: pytest cli/tests

  build-docker:
    needs: [test-orchestrator, test-cli]
    runs-on: ubuntu-latest
    steps:
      - name: Build Docker image
        run: docker build -t sre-orchestrator:${{ github.sha }} .
```

#### Deployment Verification
Steps to verify:
1. Build Docker image locally
2. Install Helm chart in test cluster
3. Verify all pods start successfully
4. Run smoke tests against deployed service
5. Verify CLI can connect to deployed orchestrator
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 7]

### Tasks / Subtasks

- [x] **(AC: 1)** **Update Docker Build:**
  - Update `Dockerfile` with new dependencies
  - Remove k8s-agent build steps
  - Optimize image size (multi-stage build if needed)
  - Test Docker build locally: `docker build -t sre-orchestrator:test .`
  - Verify image runs: `docker run sre-orchestrator:test`

- [x] **(AC: 2)** **Create CLI Distribution Package:**
  - Configure `cli/pyproject.toml` for distribution
  - Add entry point for CLI commands
  - Test package installation: `pip install cli/`
  - Test package installation: `pipx install cli/`
  - Verify CLI commands work after installation

- [x] **(AC: 3)** **Update CI/CD Pipeline:**
  - Update test jobs for new structure
  - Remove k8s-agent build and test jobs
  - Add CLI build and test jobs
  - Add coverage reporting
  - Update deployment jobs to use new Helm chart

- [x] **(AC: 4)** **Verify All Jobs Succeed:**
  - Run CI pipeline locally if possible
  - Fix any failing jobs
  - Ensure tests pass in CI environment
  - Verify Docker build succeeds in CI
  - Verify deployment job succeeds

- [x] **(AC: 5)** **Test Deployment:**
  - Deploy to test Kubernetes cluster using Helm
  - Verify all pods start successfully
  - Check pod logs for errors
  - Test health endpoint
  - Run smoke tests against deployed service
  - Test CLI connection to deployed orchestrator

- [x] **Document Deployment Process:**
  - Update deployment documentation
  - Document CLI installation process
  - Document required Kubernetes resources
  - Document environment variable configuration
  - Add troubleshooting guide

- [x] **Create Git Commit:**
  - Commit message: "chore: update deployment configuration and CI/CD pipeline"
  - Include Docker, package, and CI/CD changes
  - Never use "git add -A"

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
