---
Epic: 5
Story: 14
Title: LangGraph State Schema and Routing Logic
Status: Done
---

### Story

As a Developer, I want a well-defined state schema and routing logic for the investigation workflow, so that I can track investigation progress, add new state fields in the future, and control workflow transitions explicitly.

### Acceptance Criteria

1. A TypedDict class defines the investigation state schema with all required fields
2. The state schema includes: messages, incident_id, correlation_id, and investigation_status
3. The messages field uses the add_messages reducer annotation for automatic message appending
4. A routing function determines next steps after agent execution
5. The routing function checks if the LLM requested tool calls
6. When tool calls are present, routing directs to the tool node
7. When no tool calls are present (final answer), routing directs to the END node
8. All routing decisions are logged with correlation ID for tracing

### Dev Notes

#### State Schema Design

The state schema is the foundation of the LangGraph workflow. It defines what data flows through the graph and how it's updated at each node.

**Key Design Decisions:**
- **TypedDict**: Provides type safety and IDE autocomplete
- **add_messages reducer**: Automatically appends new messages without manual list management
- **Metadata fields**: Track incident_id and correlation_id for logging and tracing
- **Status field**: Enables workflow progress tracking and error handling

[Source: `.kiro/specs/native-langgraph-refactoring/requirements.md` Requirement 2]

#### State Schema Implementation

```python
from typing import TypedDict, Annotated, Sequence
from langchain_core.messages import BaseMessage
from langgraph.graph.message import add_messages

class InvestigationState(TypedDict):
    """
    State schema for the investigation workflow.

    The state is passed between nodes and tracks the entire investigation.
    Each node can read from and write to the state using partial updates.
    """
    # Messages list with special reducer that appends new messages
    messages: Annotated[Sequence[BaseMessage], add_messages]

    # Investigation metadata
    incident_id: str
    correlation_id: str

    # Investigation status tracking
    investigation_status: str  # "in_progress", "completed", "failed"
```

**Why add_messages reducer?**
- Automatically handles message list updates
- Nodes return `{"messages": [new_message]}` instead of managing the full list
- Prevents duplicate messages and ordering issues
- Standard LangGraph pattern for conversation workflows

[Source: `.kiro/specs/native-langgraph-refactoring/design.md` Section 1]

#### Routing Logic Implementation

```python
from typing import Literal

def should_continue(state: InvestigationState) -> Literal["tools", "end"]:
    """
    Routing function to determine if the workflow should continue to tools or end.

    This function checks the last message from the agent:
    - If it contains tool calls, route to "tools"
    - If it's a final answer, route to "end"

    Args:
        state: Current investigation state

    Returns:
        "tools" to execute tools, or "end" to finish the workflow
    """
    correlation_id = state.get("correlation_id")
    incident_id = state.get("incident_id")

    messages = state["messages"]
    last_message = messages[-1]

    # Check if the last message has tool calls
    has_tool_calls = hasattr(last_message, "tool_calls") and bool(last_message.tool_calls)

    if has_tool_calls:
        logger.info(
            "Routing to tools",
            extra={
                "correlation_id": correlation_id,
                "incident_id": incident_id,
                "tool_count": len(last_message.tool_calls)
            }
        )
        return "tools"
    else:
        logger.info(
            "Routing to end - investigation complete",
            extra={
                "correlation_id": correlation_id,
                "incident_id": incident_id
            }
        )
        return "end"
```

**Why Literal type hint?**
- Provides type safety for routing destinations
- IDE autocomplete for valid routing options
- Catch routing errors at development time

[Source: `.kiro/specs/native-langgraph-refactoring/design.md` Section 4]

#### Routing in Graph Construction

```python
from langgraph.graph import END

graph.add_conditional_edges(
    "agent",
    should_continue,
    {
        "tools": "tools",
        "end": END
    }
)
```

The conditional_edges mapping connects routing function outputs to actual node names:
- `"tools"` → routes to "tools" node
- `"end"` → routes to END (special LangGraph termination node)

[Source: `.kiro/specs/native-langgraph-refactoring/design.md` Section 5]

#### Future Extensibility

The state schema can be extended with additional fields without breaking existing nodes:

```python
class InvestigationState(TypedDict):
    messages: Annotated[Sequence[BaseMessage], add_messages]
    incident_id: str
    correlation_id: str
    investigation_status: str

    # Future extensions (optional)
    investigation_phase: str  # "initial", "deep_dive", "validation"
    iteration_count: int
    confidence_score: float
    start_time: str
    error_message: Optional[str]
```

Routing logic can also be extended with additional conditions:

```python
def should_continue_advanced(state: InvestigationState) -> Literal["tools", "validation", "end"]:
    if state["iteration_count"] > 5:
        return "end"  # Max iterations reached
    if has_tool_calls:
        return "tools"
    if state["confidence_score"] < 0.7:
        return "validation"  # Low confidence, need validation
    return "end"
```

[Source: `.kiro/specs/native-langgraph-refactoring/design.md` Extensibility Examples]

### Tasks / Subtasks

- [x] **(AC: 1, 2, 3)** **Define State Schema:**
  - Create InvestigationState TypedDict in investigation_agent.py
  - Add messages field with Annotated[Sequence[BaseMessage], add_messages]
  - Add incident_id, correlation_id, investigation_status string fields
  - Add comprehensive docstring explaining the state schema
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 1

- [x] **(AC: 4, 5, 6, 7)** **Implement Routing Function:**
  - Create should_continue function with state parameter
  - Return type: Literal["tools", "end"]
  - Check last message for tool_calls attribute
  - Return "tools" if tool calls exist
  - Return "end" if no tool calls (final answer)
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 2.1

- [x] **(AC: 8)** **Add Routing Logging:**
  - Log routing decisions with correlation_id and incident_id
  - Log tool count when routing to tools
  - Log completion message when routing to end
  - Use structured logging (JSON format)
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 2.1

- [x] **Unit Tests for State Schema:**
  - Test InvestigationState creation with all fields
  - Test add_messages reducer behavior with multiple messages
  - Test partial state updates
  - Verify state type hints work correctly
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 8.2

- [x] **Unit Tests for Routing Logic:**
  - Test should_continue with tool calls returns "tools"
  - Test should_continue without tool calls returns "end"
  - Test should_continue with empty messages list
  - Test logging in routing function
  - Mock messages and verify routing decisions
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 8.1

- [x] **Update Documentation:**
  - Document state schema in investigation_agent.py docstrings
  - Document routing logic in should_continue docstring
  - Add inline comments explaining add_messages reducer
  - Add examples of state updates
  - Reference: `.kiro/specs/native-langgraph-refactoring/tasks.md` Task 9.3

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-15 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
Claude Sonnet 4.5

#### Debug Log References
_TBD_

#### Completion Notes List
- State schema uses TypedDict for type safety and extensibility
- add_messages reducer simplifies message list management
- Routing logic is simple and easy to understand
- Comprehensive logging for debugging workflow transitions
- State schema can be extended without breaking existing nodes

#### File List
- investigation_agent.py: InvestigationState class and should_continue function
- tests/test_investigation_state.py: State schema tests
- tests/test_routing_logic.py: Routing function tests

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
