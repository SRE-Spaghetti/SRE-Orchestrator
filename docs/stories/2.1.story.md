---
Epic: 2
Story: 1
Title: K8s Agent Service & Cluster Connection
Status: Approved
---

### Story

As a Developer, I want to create a new Python microservice for the Kubernetes Agent and configure it to connect to the in-cluster Kubernetes API, so that it has the foundational structure and permissions to perform its diagnostic tasks.

### Acceptance Criteria

1.  A new Python application is created in the monorepo (e.g., in `k8s-agent`).
2.  The agent is configured to use a Kubernetes Service Account to authenticate with the in-cluster API.
3.  The agent's Helm chart is updated to include the necessary RBAC roles and role bindings for read-only access to pods and their logs.
4.  Upon startup, the agent successfully initializes a Kubernetes client and can perform a basic API call (e.g., listing pods in its own namespace) to verify the connection.
5.  The agent exposes its own `/health` endpoint.

### Dev Notes

#### Tech Stack & Project Structure
- **Language:** Python 3.12.4 [Source: `architecture/components.md`]
- **Framework:** FastAPI 0.111.0 [Source: `architecture/components.md`]
- **Dependency Management:** Poetry 1.8.2 [Source: `architecture/components.md`]
- **Kubernetes Client:** `kubernetes` Python client library [Source: `architecture/components.md`]
- **Project Location:** The new service should be created at `services/k8s-agent/`. [Source: `architecture/source-tree.md`]
- **Application Structure:** Follow the same structure as the `orchestrator` service (`app/main.py`, `app/api/v1/`, etc.). [Source: `architecture/source-tree.md`]

#### Kubernetes & Helm
- **Authentication:** The application must be configured to load the in-cluster Service Account token to communicate with the Kubernetes API. [Source: `architecture/security.md`]
- **Helm Chart:** The main `sre-orchestrator` Helm chart in the `charts/` directory needs to be updated.
- **RBAC:** A `Role` and `RoleBinding` (or `ClusterRole` and `ClusterRoleBinding` if cross-namespace access is needed, but start with `Role`) must be created in the Helm chart. The role should grant `get`, `list`, and `watch` permissions on `pods` and `pods/log`. [Source: `AC: 3`]

#### Testing
- **Framework:** `pytest` [Source: `architecture/test-strategy-and-standards.md`]
- **Location:** `services/k8s-agent/tests/unit/` [Source: `architecture/test-strategy-and-standards.md`]
- **Coverage:** Unit tests should cover the health endpoint and mock the Kubernetes client initialization to verify its behavior. [Source: `architecture/test-strategy-and-standards.md`]

### Tasks / Subtasks

1.  **(AC: 1)** **Initialize K8s Agent Service:**
    - Create the directory `services/k8s-agent`.
    - Initialize a new Poetry project within it, adding `fastapi`, `uvicorn`, `kubernetes`, and `pytest` as dependencies.
    - Create the application directory structure (`app/main.py`, etc.) mirroring the orchestrator service.
2.  **(AC: 5)** **Implement Health Endpoint:**
    - In the `k8s-agent`'s `main.py`, create a FastAPI application.
    - Add a `GET /health` endpoint that returns `{"status": "ok"}` with a 200 status code.
3.  **(AC: 2, 4)** **Implement Kubernetes Client:**
    - Create a new service/module (e.g., `app/services/k8s_client.py`).
    - In this module, write a function to initialize the Python Kubernetes client. It should use `kubernetes.config.load_incluster_config()` to automatically load the service account credentials.
    - Add logic to the application's startup sequence to call this initialization function and verify the connection by listing pods in the agent's own namespace. Log the result.
4.  **(AC: 3)** **Update Helm Chart for K8s Agent:**
    - In `charts/sre-orchestrator/templates/`, add a new `deployment-k8s-agent.yaml` and `service-k8s-agent.yaml`.
    - Create `rbac.yaml` to define a `Role` with read-only access to pods and logs, and a `RoleBinding` to bind that role to the agent's `ServiceAccount`.
    - Ensure the `deployment-k8s-agent.yaml` references the correct `ServiceAccount`.
5.  **Write Unit Tests:**
    - In `services/k8s-agent/tests/unit/`, write a unit test for the `/health` endpoint.
    - Write a unit test for the Kubernetes client initialization, mocking the `kubernetes.config.load_incluster_config()` and the client API call to verify it's called correctly on startup.

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| _TBD_ | 1.0 | Initial Draft | _TBD_ |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
