---
Epic: 5
Story: 5
Title: Update Incident Repository for Async Workflow
Status: Done
---

### Story

As a Developer, I want to refactor the incident repository to work with the asynchronous LangGraph workflow, so that incident investigations can run asynchronously and track investigation steps.

### Acceptance Criteria

1. The `IncidentRepository.create()` method is updated to be async
2. The repository uses the LangGraph agent for investigation instead of manual LLM calls
3. The k8s_agent_client dependency is removed from the repository
4. The Incident model includes an `investigation_steps` field to track workflow progress
5. The InvestigationStep model is created to represent individual investigation steps
6. Incident status transitions support the async workflow ("pending" → "investigating" → "completed"/"failed")

### Dev Notes

#### Updated Incident Model
```python
class Incident(BaseModel):
    id: UUID
    description: str
    status: Literal["pending", "investigating", "completed", "failed"]
    created_at: datetime
    completed_at: Optional[datetime]
    evidence: Dict[str, Any]
    extracted_entities: Dict[str, Any]
    suggested_root_cause: Optional[str]
    confidence_score: Optional[Literal["high", "medium", "low"]]
    investigation_steps: List[InvestigationStep] = []  # New field
    error_message: Optional[str] = None  # New field

class InvestigationStep(BaseModel):
    step_name: str
    timestamp: datetime
    status: Literal["started", "completed", "failed"]
    details: Dict[str, Any]
```
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 5]

#### Repository Refactoring
- Update `IncidentRepository.create()` to be async
- Replace manual LLM calls with agent invocation
- Remove k8s_agent_client dependency
- Use LangGraph agent for investigation
- Store investigation steps in incident model
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 5.1]

#### Investigation Step Tracking
Each action by the agent should be tracked as a step:
- Tool invocations (e.g., "get_pod_logs")
- Analysis phases (e.g., "entity_extraction", "root_cause_analysis")
- Timestamps and status for each step
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 5.2]

#### Status Management
- "pending": Incident created, investigation not started
- "investigating": Agent is running
- "completed": Investigation finished successfully
- "failed": Investigation encountered an error
[Source: `.kiro/specs/orchestrator-refactoring/tasks.md` Task 5.3]

#### Error Handling
- Capture workflow errors and update status to "failed"
- Store error messages in incident model
- Preserve partial investigation results
[Source: `.kiro/specs/orchestrator-refactoring/design.md` Section 4]

### Tasks / Subtasks

- [x] **(AC: 4, 5)** **Update Data Models:**
  - Add `investigation_steps` field to Incident model
  - Add `error_message` field to Incident model
  - Create `InvestigationStep` model
  - Update status literals to include "investigating"

- [x] **(AC: 1, 2)** **Refactor Incident Creation:**
  - Update `IncidentRepository.create()` to be async
  - Replace manual LLM calls with `investigate_incident()` from agent module
  - Remove entity extraction and analysis logic (handled by agent)

- [x] **(AC: 3)** **Remove K8s Agent Client Dependency:**
  - Remove k8s_agent_client imports from incidents.py
  - Remove k8s_agent_client from dependency injection
  - Update any code that used k8s_agent_client

- [x] **(AC: 6)** **Implement Status Management:**
  - Update status to "investigating" when agent starts
  - Update status to "completed" when agent finishes successfully
  - Update status to "failed" on errors
  - Store error messages in incident model

- [x] **(AC: 4)** **Add Investigation Step Tracking:**
  - Track each agent action as an InvestigationStep
  - Store step timestamps and status
  - Include step details (tool parameters, results)

- [x] **Write Unit Tests:**
  - Test async incident creation
  - Test investigation step tracking
  - Test status transitions
  - Test error handling

- [x] **Create Git Commit:**
  - Commit message: "refactor: update incident repository for async LangGraph workflow"
  - Include incident model and repository changes

### Change Log

| Date | Version | Description | Author |
| --- | --- | --- | --- |
| 2025-11-14 | 1.0 | Initial draft | Yi (Dev) |

### Dev Agent Record

#### Agent Model Used
_TBD_

#### Debug Log References
_TBD_

#### Completion Notes List
-

#### File List
-

### QA Results

- **Status:** Not yet reviewed
- **Date:**
- **Reviewed by:**
- **Summary:**
- **Issues Found:**
- **Recommendations:**
